<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stackoverflow Team Launchpad Pixel Art Maker</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Press+Start+2P">
    <link href="https://use.fontawesome.com/releases/v5.0.8/css/all.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: 'Press Start 2P', cursive;
            background-color: black;
            color: white;
        }

        h1 {
            font-size: 45px;
            padding-top: 15px;
            text-shadow: 3px 3px 5px hotpink;
        }

        h2 {
            margin: 0.5em 0;
        }

        canvas {
            margin: 20px 0;
            outline: 3px solid white;
            width: 160mm;
            height: 160mm;
            image-rendering: pixelated;
            background-color: black;
            cursor: crosshair;
        }

        form {
            margin-top: 10px;
        }
    </style>
</head>

<body onload="init()">
    <h1>Pixel Art Maker</h1>
    <canvas id="canvas" width="16" height="16"></canvas>
    <form>
        <label for="draw_color">Choose color: </label>
        <input type="color" id="draw_color" value="#FFFFFF">
    </form>

    <script>
        const drawTopic = 'steffiPeTaffy/draw';
        const connectTopic = 'steffiPeTaffy/draw/connect';
        let canvas, context, client, active = false;

        function init() {
            client = new Paho.MQTT.Client('wss://broker.emqx.io:8084/mqtt', Math.random().toString(36).substring(7));
            canvas = document.getElementById("canvas");
            context = canvas.getContext("2d");

            client.onConnectionLost = onConnectionLost;
            client.onMessageArrived = onMessageArrived;
            client.connect({ onSuccess: onConnect });

            // Background Fill
            context.fillStyle = "black";
            context.fillRect(0, 0, canvas.width, canvas.height);

            let rect = canvas.getBoundingClientRect();
            let pixelWidth = rect.width / canvas.width;
            let pixelHeight = rect.height / canvas.height;

            function getPixelCoordinates(e) {
                return {
                    x: Math.floor((e.clientX - rect.left) / pixelWidth),
                    y: Math.floor((e.clientY - rect.top) / pixelHeight)
                };
            }

            canvas.addEventListener("mousedown", () => active = true);
            canvas.addEventListener("mouseup", () => active = false);
            canvas.addEventListener("mousemove", e => { if (active) draw(getPixelCoordinates(e)); });
            canvas.addEventListener("click", e => draw(getPixelCoordinates(e)));
        }

        function onConnect() {
            console.log("Connected to MQTT");
            client.subscribe(drawTopic);
            let message = new Paho.MQTT.Message("1");
            message.destinationName = connectTopic;
            client.send(message);
        }

        function onConnectionLost(response) {
            if (response.errorCode !== 0) {
                console.log("Connection lost: " + response.errorMessage);
                setTimeout(() => client.connect({ onSuccess: onConnect }), 3000); // Reconnect delay
            }
        }

        function onMessageArrived(message) {
            console.log("Message arrived: " + toHexString(message.payloadBytes));
            let x = message.payloadBytes[0];
            let y = message.payloadBytes[1];
            let color = '#' + toHexString(message.payloadBytes.slice(2, 5));
            context.fillStyle = color;
            context.fillRect(x, y, 1, 1);
        }

        function toHexString(byteArray) {
            return Array.from(byteArray, byte => ('0' + (byte & 0xFF).toString(16)).slice(-2)).join('');
        }

        function sendMessage(x, y, color) {
            let payload = new Uint8Array(5);
            payload[0] = x;
            payload[1] = y;
            payload[2] = parseInt(color.substr(1, 2), 16);
            payload[3] = parseInt(color.substr(3, 2), 16);
            payload[4] = parseInt(color.substr(5, 2), 16);

            let message = new Paho.MQTT.Message(payload);
            message.destinationName = drawTopic;
            client.send(message);
        }

        function draw({ x, y }) {
            let color = document.getElementById("draw_color").value;
            context.fillStyle = color;
            context.fillRect(x, y, 1, 1);
            sendMessage(x, y, color);
        }
    </script>
</body>

</html>